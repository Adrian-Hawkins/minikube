<source>
  @type tail
  path /app/logs/*.log
  pos_file /app/logs/fluentd.pos
  tag app.logs
  read_from_head true
  <parse>
    @type regexp
    expression /^(?<time>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3}) (?<level>\w+) (?<message>.*)$/
    time_format %Y-%m-%d %H:%M:%S,%L
  </parse>
</source>

<filter app.logs>
  @type record_transformer
  enable_ruby true
  <record>
    log ${record["level"] + " " + record["message"]}
    filename ${tag_parts[-1]}
  </record>
  remove_keys time, level, message
</filter>

<match app.logs>
  @type loki
  url "http://loki:3100"
  extra_labels {"job":"fluentd"}
  flush_interval 10s
  flush_at_shutdown true
  buffer_chunk_limit 1m
  <label>
    job
    filename
  </label>
  <buffer>
    @type memory
    flush_interval 5s
    chunk_limit_size 1m
    retry_max_times 5
  </buffer>
</match>